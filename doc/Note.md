# ä½œä¸šå›é¡¾ä¸æ€è€ƒ

*å­¦è€Œä¸æ€åˆ™ç½”, æ€è€Œä¸å­¦åˆ™æ®†ã€‚--ã€Šè®ºè¯­ã€‹*

**ä¸‹é¢ä»…è®°å½•äº†æˆ‘é‡åˆ°è¿‡çš„é—®é¢˜ã€‚æ­£ç¡®ç­”æ¡ˆåªæœ‰ä¸€ä¸ªï¼Œä½†æ˜¯é”™è¯¯å¯ä»¥åƒåƒä¸‡ä¸‡ã€‚å¦‚æœ‰é›·åŒï¼Œé‚£æ­å–œæˆ‘ä»¬æ˜¯åŒæ ·çš„bugã€‚**

## ä½œä¸š0 & ä½œä¸š1
  * æ²¡æœ‰é—®é¢˜!

## ä½œä¸š2
> <img src="./hw2.png" width = "25%" height = "25%" alt="æ²¡æœ‰MSAA" align=center />&emsp;<img src="./hw2withblackbounder.png" width = "25%" height = "25%" alt="MSAAä½†æœ‰é»‘è¾¹" align=center />&emsp;<img src="./hw2massright.png" width = "25%" height = "25%" alt="MSAAæ­£å¸¸" align=center /><p>
å›¾ç¤º: å›¾1æ²¡æœ‰ä½¿ç”¨MSAA,æœ‰æ˜æ˜¾é”¯é½¿ï¼›å›¾2é”™è¯¯çš„MSAAï¼Œæœ‰é»‘è¾¹ï¼›å›¾3, MSAA, é”¯é½¿ç¼“è§£ï¼Œæ— é»‘è¾¹ã€‚(ps.åŸå›¾å·®åˆ«æ˜æ˜¾)


1. ç”»å‡ºæ¥çš„ä¸¤ä¸ªä¸‰è§’å½¢å †å å…ˆåä¸æ•ˆæœå›¾ç›¸å?
   * æ·±åº¦æµ‹è¯•çš„é—®é¢˜ã€‚åœ¨ä½œä¸š1ä¸­çš„**get_projection_matrixå‡½æ•°**ä¸­æ·±åº¦æ˜¯**è´Ÿæ•°**, è´Ÿæ•°è¶Šå°è¯´æ˜è¶Šæ¥è¿‘å±å¹•ã€‚
   * åœ¨**rasterizer.cpp**ä¸­ç»è¿‡viewport transformationåï¼ŒåŸæœ¬è·ç¦»å±å¹•æ›´è¿‘ç‚¹çš„Zåæ ‡å€¼å´è¶Šå¤§ã€‚
   * ç»è¿‡è½¬æ¢åçš„Zå€¼ä¼šåœ¨**rasterize_triangleå‡½æ•°**ä¸­è¢«è§†ä½œè·ç¦»ï¼Œä¹Ÿå³è·ç¦»å±å¹•è¶Šè¿‘çš„ç‚¹ï¼ŒZåæ ‡å€¼åº”è¶Šå°ã€‚è‡³æ­¤ï¼Œæ•ˆæœå›¾ä¸­ä¼šå‡ºç°ç¦»å±å¹•è¶Šè¿œçš„ç‚¹è¦†ç›–è¶Šè¿‘çš„ç‚¹çš„ç°è±¡ã€‚
   * Zå€¼ç›¸åï¼Œåˆ™åœ¨**get_projection_matrix**å‡½æ•°ä¸­ï¼Œåšä¸€æ¬¡Zè½´å¯¹ç§°çš„å˜æ¢å³å¯ã€‚


2. MSAAæœ‰é»‘è¾¹?
    * é»‘è¾¹å½¢æˆçš„åŸå› ä¸å…·ä½“å®ç°æœ‰å…³ã€‚
      * æ²¡æœ‰ä¿å­˜æ¬¡åƒç´ çš„æ·±åº¦å’Œé¢œè‰², å›¾å½¢è¾¹ç•Œæ›´æ–°åƒç´ ç‚¹çš„é¢œè‰²åªä¸é å‰çš„å›¾å½¢é¢œè‰²ç›¸å…³ï¼Œå¹¶ä¸”ä¼šå–é¢œè‰²çš„ç™¾åˆ†æ¯”ï¼Œè¾¹ç•Œä¼šæš—ä¸€äº›ã€‚
      * ä¿å­˜äº†æ¬¡åƒç´ çš„æ·±åº¦å’Œé¢œè‰²ï¼Œä½†æ˜¯ç›®æ ‡åƒç´ çš„**æ›´æ–°æ–¹å¼**æœ‰å˜ï¼Œä¸»è¦åŒºåˆ«ä¸ºMSAAæ›´æ–°åƒç´ å€¼ä¸ç”¨å†æ£€æŸ¥æ·±åº¦, ä»£ç å¦‚ä¸‹ï¼š
  ```c++
    auto update_depth_and_color = [this](int x, int y, float test_depth, const Vector3f& color, bool update_color_with_depth_check=true){
        int index = get_index(x, y);
        if(test_depth < depth_buf[index])
        {
            depth_buf[index] = test_depth;
            if(update_color_with_depth_check)
                set_pixel({x * 1.f, y * 1.f, test_depth}, color);
        }
        if(!update_color_with_depth_check)
        {
            set_pixel({x * 1.f, y * 1.f, test_depth}, color);
        }
    };
  ```

  ## ä½œä¸š3
  > <img src="./hw3normal.png" width = "25%" height = "25%" alt="æ¸²æŸ“æ³•çº¿" align=center />&emsp;<img src="./hw3phong.png" width = "25%" height = "25%" alt="æ¸²æŸ“å¸ƒæ—å†¯å…‰ç…§æ¨¡å‹" align=center />&emsp;<img src="./hw3texture.png" width = "25%" height = "25%" alt="å…‰ç…§æ¨¡å‹å’Œçº¹ç†" align=center />&emsp;<p><img src="./hw3bump.png" width = "25%" height = "25%" alt="æ¸²æŸ“bumpçº¹ç†" align=center />&emsp;<img src="./hw3dispacement.png" width = "25%" height = "25%" alt="displaceçº¹ç†" align=center /><p>
å›¾ç¤º: å›¾1:æ³•çº¿ï¼›å›¾2:å¸ƒæ—å†¯å…‰ç…§æ¨¡å‹ï¼›å›¾3:å¸¦çº¹ç†çš„å…‰ç…§æ¨¡å‹; å›¾4:bumpçº¹ç†; å›¾5:displacementçº¹ç†ã€‚

1. Displacementçº¹ç†æ¸²æŸ“ç»“æœä¸æ¸²æŸ“å›¾ä¸åŒï¼Ÿ
  * é‡åˆ°çš„ä¸»è¦é—®é¢˜æ˜¯æ¸²æŸ“å‡ºdisplacementçº¹ç†çš„æ•ˆæœä¼šè¡¨é¢æ›´åŠ ç²—ç³™ï¼Ÿåœ¨åŸå§‹çš„å®ç°ä¸­ï¼Œ**displacement_fragment_shader**ä¸­å…ˆè®¡ç®—normalï¼Œåæ›´æ–°pointçš„ä½ç½®ã€‚pointçš„æ›´æ–°ä¸­ï¼Œnormalä¹Ÿå‚ä¸è®¡ç®—ã€‚è€Œnormalé€šè¿‡bumpè´´å›¾æ›´æ–°å€¼åï¼Œç›¸å½“äºå¯¹normalåšäº†ä¸€æ¬¡"æ‰°ä¹±"ï¼Œç”¨æ›´æ–°åçš„normalå»æ›´æ–°point, åˆ™ä½¿å¾—æ¨¡å‹æ¸²æŸ“è§‚æ„Ÿæ›´åŠ "ç²—ç³™"ã€‚ç”±æ­¤ï¼Œå¯ä»¥æ¨æµ‹bumpè´´å›¾åšäº†ä¸¤ä»¶äº‹:æ”¹å˜é¡¶ç‚¹çš„é€»è¾‘ä½ç½®(åŸæœ¬ç½‘æ ¼ä¸­ä¸å˜)ï¼›æ”¹å˜é¡¶ç‚¹æ³•çº¿ã€‚

## ä½œä¸š4
> <img src="./hw4_1.png" width = "25%" height = "25%" alt="è´å¡å°”æ›²çº¿" align=center />&emsp; <img src="./hw4_2.png" width = "25%" height = "25%" alt="æŠ—é”¯é½¿" align=center />&emsp;<p>
å›¾ç¤º: å›¾1: è´å¡å°”æ›²çº¿ï¼Œå›¾2: æ•ˆæœä¸æ˜¯å¾ˆå¥½çš„è´å¡å°”æ›²çº¿æŠ—é”¯é½¿

1. å¦‚ä½•åšè´å¡å°”æ›²çº¿çš„æŠ—é”¯é½¿ï¼Ÿ
* [todo] å°è¯•äº†ä¸€äº›åŠæ³•ï¼Œä½†å°šæœªæ‰¾åˆ°ä¸€ä¸ªæ¯”è¾ƒå¥½çš„æ–¹å¼ã€‚

## ä½œä¸š5
> <img src="./hw5_out.png" width = "50%" height = "25%" alt="RayTracing" align=center />&emsp;<p>
å›¾ç¤º: å›¾1: å®éªŒæ•ˆæœå›¾

1. å¦‚ä½•è®¡ç®—ä¸–ç•Œç©ºé—´åƒç´ ç‚¹åæ ‡å’Œæ–¹å‘ï¼Ÿ
* è¯¥èŠ‚ä½œä¸šçš„å®ç°å…³é”®ç‚¹åœ¨äºå»ç†è§£ä½œä¸šä¸­Renderå‡½æ•°ä¸­scaleçš„â€œéšè—å«ä¹‰â€ï¼šå®ƒé»˜è®¤zNear(è¿‘å¹³é¢è·ç¦»)æ˜¯1.0fã€‚ç„¶åï¼Œé…åˆè™ä¹¦ç¬¬å››ç« ç†è§£ä¸–ç•Œç©ºé—´ä¸­åƒç´ ä½ç½®x,y(è™ä¹¦ä¸­è®°ä¸ºu,v)çš„è®¡ç®—æ–¹æ³•å³å¯ã€‚
2. å¾—çŸ¥x,yè®¡ç®—æ–¹æ³•åï¼Œä½œå‡ºç»“æœå¯èƒ½æ˜¯ä¸Šä¸‹é¢ å€’çš„ï¼Ÿ
* è¯·æ³¨æ„ï¼Œè¿™é‡Œçš„é¢ å€’é€ æˆçš„åŸå› (æˆ‘è®¤ä¸º)æ˜¯ä¸framebufferçš„ä½¿ç”¨æ–¹å¼æœ‰å…³ï¼Œå³framebufferå¯¼å‡ºçš„ppmå›¾ç‰‡çš„åæ ‡åŸç‚¹åœ¨å·¦ä¸Šè§’(ä»å·¦è‡³å³ï¼Œä»ä¸Šè‡³ä¸‹)ï¼Œè€Œè™ä¹¦ä¸­å‡è®¾åƒç´ ç©ºé—´çš„åŸç‚¹åœ¨å·¦ä¸‹è§’ã€‚


## ä½œä¸š6
> <img src="./hw6_native_out.png" width = "25%" height = "25%" alt="RayTracing" align=center />&emsp;<img src="./bvh_time.png" width = "50%" height = "50%" alt="RayTracing" align=center />
> <img src="./hw6_sah_out.png" width = "25%" height = "25%" alt="RayTracing" align=center />&emsp;<img src="./sah_time.png" width = "50%" height = "50%" alt="RayTracing" align=center /><p>
å›¾ç¤º: å›¾1: BVHåŠ é€Ÿæ¸²æŸ“æ•ˆæœå›¾, å›¾2:BVHè¿è¡Œæ—¶é—´(DEBUGæ¨¡å¼), å›¾3: BVH(SAHæ„å»º)æ•ˆæœå›¾, å›¾4: BVH(SAHæ„å»º)è¿è¡Œæ—¶é—´(DEBUGæ¨¡å¼)

0. ä½œä¸š6ç›¸å¯¹æœ‰æ›´å¤šçš„ä¸€äº›ç®—æ³•æ¶‰åŠï¼Œè¿™é‡Œé¡ºåºåˆ—å‡ºæ¶‰åŠåˆ°çš„è¿‡ç¨‹å’Œç®—æ³•ã€‚
* åˆ›å»ºä¸€ä¸ªåœºæ™¯ï¼Œè½½å…¥æ¨¡å‹ï¼Œè®¾ç½®ç¯å…‰
* è®¾ç½®åœºæ™¯çš„BVHã€‚
  * [ç®—æ³•1]æ„é€ BVHç»“æ„
* éå†æ‰€æœ‰åƒç´ 
  * å½“å‰åƒç´ ç”Ÿæˆä¸€æ¡å°„çº¿ray
  * æ±‚åœºæ™¯ä¸rayçš„äº¤ç‚¹
    * [ç®—æ³•2]BVHç»“æ„åŠ é€Ÿæ±‚å°„çº¿ä¸åœºæ™¯ä¸­å¯¹è±¡çš„äº¤ç‚¹
      * [ç®—æ³•3]BoundBoxä¸å°„çº¿æ˜¯å¦æœ‰äº¤ç‚¹
      * [ç®—æ³•4]å°„çº¿ä¸ä¸‰è§’å½¢æ±‚äº¤ç‚¹
  * æ±‚äº¤ç‚¹å¤„å…‰ç…§æ¨¡å‹åƒç´ å€¼
* ä¿å­˜æ‰€æœ‰åƒç´ ç‚¹å¤„åƒç´ ï¼Œå¯¼å‡ºæˆPPM

**ç®—æ³•1**:ä¸Šè¿°è¿‡ç¨‹ä¸­ç®—æ³•1æä¾›çš„ç©ºé—´ç»“æ„åˆ’åˆ†æ–¹æ³•æ˜¯ä¸€ç§ç±»ä¼¼äºâ€œä¸»æˆåˆ†äºŒåˆ†æ³•â€ã€‚ç¬¼ç»Ÿåœ°è¯´ï¼Œè¿›è¡Œä¸€æ¬¡ç©ºé—´åˆ†å‰²ï¼šè·å¾—æ‰€æœ‰å›¾å…ƒä¸‰è§’å½¢â€œä¸­å¿ƒâ€Xï¼ŒYï¼ŒZèŒƒå›´ï¼Œå–å–å€¼èŒƒå›´å¤§çš„è½´ï¼Œå°†å…¶è§†ä¸ºåˆ†å‰²ä¸»æˆåˆ†ï¼ŒæŒ‰2åˆ†çš„æ€æƒ³å°†å…¶åˆ†ä¸º2ä¸ªç©ºé—´åˆ†å‰², ä½¿å¾—ä¸¤ä¸ªç©ºé—´æœ‰ç›¸åŒæ•°é‡çš„å›¾å…ƒä¸‰è§’å½¢ã€‚æ•´ä½“ä¸Šï¼Œå¯¹å®Œæ•´ç©ºé—´åšä¸€æ¬¡åˆ†å‰²ï¼Œç„¶åå¯¹åˆ†å‰²å‡ºæ¥çš„2éƒ¨åˆ†é€’å½’è°ƒç”¨åˆ†å‰²ç®—æ³•ã€‚

**ç®—æ³•2**: é€’å½’ç®—æ³•ï¼Œè§è™ä¹¦ç¬¬12.3.2èŠ‚ä»‹ç»

**ç®—æ³•3**: ç›¸å¯¹ç®€å•ï¼Œè§è™ä¹¦ç¬¬12.3.1èŠ‚ä»‹ç»

**ç®—æ³•4**:101è¯¾ç¨‹é‡Œä»‹ç»çš„Moller Trumbore Alg.

---

1. èƒ½ç”»å‡ºæ•ˆæœå›¾ï¼Œä½†æ˜¯è€—æ—¶å¤§äº80s(ä»»æ„å¾ˆå¤§çš„å€¼)ï¼Ÿ
* é€šå¸¸BVHå®éªŒè¿è¡Œæ—¶é—´åº”è¯¥ä¸ä¼šå¤§äº10s(ç‰¹åˆ«è€çš„CPUä¸èƒ½ä¿è¯)ã€‚æ•ˆæœå›¾èƒ½å‡ºè¯´æ˜å°„çº¿æ±‚äº¤ç­‰éƒ¨åˆ†æ²¡æœ‰é—®é¢˜ï¼Œé—®é¢˜å¯èƒ½å‡ºåœ¨é€’å½’BVHæ±‚äº¤ç‚¹çš„éƒ¨åˆ†, å³**BVHAccel::getIntersection**å‡½æ•°ã€‚å¦‚æœè€—æ—¶éå¸¸å¤§ï¼Œè¯´æ˜BVHå¹¶æ²¡æœ‰èµ·åˆ°åŠ é€Ÿä½œç”¨ï¼Œæ³¨æ„æ’æŸ¥é€’å½’å‡ºå£ã€‚ä¸‹é¢æ˜¯æˆ‘çŠ¯çš„ä½çº§é”™è¯¯ğŸ˜­, å‘ç°é—®é¢˜äº†å—ï¼Ÿ
```c++
Intersection BVHAccel::getIntersection(BVHBuildNode *node,
                                       const Ray &ray) const {
  // TODO Traverse the BVH to find intersection

  // recursive exitã€‚
  // error: use root node to check ray&BoundingBox Intersection. BVH does't work in fact.
  // please using "node" to instead "root".
  if (node == nullptr || !root->bounds.IntersectP(ray, ray.direction_inv,
                                                  {int(ray.direction.x < 0),
                                                   int(ray.direction.y < 0),
                                                   int(ray.direction.z < 0)}))
    return {};

  // leave node ray&object intersection check
  if (node->left == nullptr && node->right == nullptr) {
    return node->object->getIntersection(ray);
  }

  // recursive part
  auto left_inter = getIntersection(node->left, ray);
  auto right_inter = getIntersection(node->right, ray);
  return left_inter.distance < right_inter.distance ? left_inter : right_inter;
```

2. å…³äºSAHç®—æ³•, å®ç°æ–¹æ³•æœ‰å‡ ç§ï¼Œæ•ˆæœåœ¨è¿™ä¸ªå®éªŒä¸‹ä¼šæ¯” BVH NAIVEæ„å»ºæ–¹å¼å¿«ä¸Š1ç§’å·¦å³ã€‚è¿™ä¸ªçŸ¥è¯†ç‚¹çš„æ‰©å±•æ¯”è¾ƒå…³æ³¨çš„æ˜¯ä¸ºä»€ä¹ˆBVH NAIVEçš„æ„å»ºæ–¹å¼çš„ç¼ºç‚¹ï¼Œä»¥åŠSAHç›¸æ¯”å®ƒçš„ä¼˜ç‚¹åœ¨å“ªé‡Œã€‚æ­¤[æ–‡ç« ](https://zhuanlan.zhihu.com/p/50720158)åˆ†æäº†BVHæ„å»ºæ–¹å¼çš„ä¼˜ç¼ºç‚¹ï¼Œå€¼å¾—ä¸€çœ‹ã€‚
* æ„Ÿå®˜ä¸Šçš„è®¤è¯†:ä¸€ç§å¥½çš„åˆ’åˆ†è¦æ»¡è¶³åŒ…å›´ç›’ç´§è‡´ã€‚åŒ…å›´ç›’å¦‚æœæ²¡é‚£ä¹ˆç´§è‡´ï¼Œå°„çº¿æœ‰æ›´å¤§çš„å‡ ç‡ä¸å…¶ç›¸äº¤ï¼Œä½¿å¾—é€’å½’å»æ£€æŸ¥å­æ ‘ä¸Šçš„ç›¸äº¤å…³ç³»ï¼Œå°½ç®¡å¯èƒ½å…¶å†…éƒ¨å¹¶æ²¡æœ‰ä¸å°„çº¿ç›¸äº¤ï¼Œç›¸å½“äºè€—æ—¶ã€‚é‡‡ç”¨æ•°é‡å‡åˆ†ï¼Œæˆ–è€…åæ ‡è½´ä¸­ç‚¹çš„åˆ’åˆ†æ–¹å¼åªè€ƒè™‘åŒ…å›´ç›’åœ¨ç©ºé—´ä¸­çš„"å‡åŒ€â€œåˆ’åˆ†ï¼Œä½†æ˜¯è¿™ç§åˆ’åˆ†æ˜¯ä¸è€ƒè™‘è¾¹ç•Œå…³ç³»çš„ï¼Œä¹Ÿå°±æ˜¯å®¹æ˜“å‡ºç°åŒ…å›´ç›’èŠ‚ç‚¹èŒƒå›´åå¤§ï¼Œå®¹æ˜“é€ æˆåŒ…å›´ç›’è¾¹ç•Œç›¸äº¤çš„æƒ…å†µã€‚SAHçš„å¥½å¤„è‡ªç„¶æ˜¯è€ƒè™‘äº†è¾¹ç•Œçš„åšæ³•ï¼Œæ‰€è°“SAHè®¡ç®—çš„æŸå¤±å‡½æ•°ä¸­å°±åŒ…æ‹¬äº†å­åŒ…å›´ç›’é¢ç§¯ä¸çˆ¶åŒ…å›´ç›’é¢åŸºçš„æ¯”å€¼ï¼Œä½œä¸ºä¸€ç§è¾¹ç•Œâ€œç´§è‡´â€çš„è¡¡é‡æ–¹å¼ã€‚


